<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Dashboard IA Real ‚Äî Demo con Comentarios (M√≥vil)</title>
<style>
:root{
  --blue:#1e66b0; --bg:#f7f9fc; --card-bg:#fff; --muted:#6b7280;
  --radius:10px; --accent:#0b4f84; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;}
body{
  display:flex;align-items:flex-start;justify-content:center;background:var(--bg);padding:14px;color:#0f1724;
}
.app{
  width:100%; max-width:920px; min-height:100vh; display:grid; grid-template-columns:1fr; gap:14px;
}

/* Panels */
.panel{background:var(--card-bg);border-radius:var(--radius);box-shadow:0 6px 18px rgba(15,23,36,0.06);padding:14px;}
.centered{display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;min-height:260px;}

/* Forms */
form{width:100%;max-width:460px;display:flex;flex-direction:column;gap:10px;}
label{font-size:13px;color:var(--muted);}
input[type="text"],input[type="password"],textarea{
  padding:10px 12px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;font-size:15px;width:100%;
}
textarea{resize:none;}
.row{display:flex;gap:10px;flex-wrap:wrap;}
button{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:white;font-weight:700;cursor:pointer;font-size:15px;}
button.ghost{background:transparent;border:1px solid var(--accent);color:var(--accent);}

/* Dashboard layout */
.dashboard{display:flex;flex-direction:column;gap:12px;min-height:520px;}
.topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px;}
.metric{background: rgba(11,79,132,0.04);border-radius:8px;padding:12px;display:flex;gap:12px;align-items:center;justify-content:space-between;min-height:52px;}
.metric h3{font-size:13px;margin:0;color:var(--muted);}
.metric .value{font-weight:800;font-size:18px;color:#05233a;}
.big-stat{border-radius:8px;padding:12px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:6px;background:linear-gradient(180deg, rgba(11,79,132,0.03), rgba(11,79,132,0.01));}
.big-stat .num{font-size:28px;font-weight:800;color:var(--accent);}
.big-stat .label{color:var(--muted);font-size:13px;}
.small{font-size:13px;color:var(--muted);text-align:center;}

/* Comments modal */
.commentsModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:999;padding:12px;}
.commentsContent{background:#fff;border-radius:12px;padding:14px;max-width:540px;width:100%;max-height:86%;overflow-y:auto;position:relative;}
.comment{border-bottom:1px solid #eee;padding:8px 0;}
.comment p{margin:6px 0;}
.reply{margin-left:12px;padding:4px 0;font-size:14px;}

/* Camera and fallback */
.cameraWrapper{display:flex;flex-direction:column;gap:8px;align-items:center;}
video#webcam{width:100%;max-width:460px;border-radius:10px;background:#000;object-fit:cover;}
#activateFallback{display:none;width:100%;padding:12px;border-radius:10px;border:0;background:#0b8a4a;color:#fff;font-weight:700;}
#fileCam{display:none;}

/* Responsive mobile */
@media (max-width:520px){
  .panel{padding:12px;}
  button{padding:12px;font-size:16px;border-radius:12px;}
  .centered{min-height:320px;}
  .topbar{flex-direction:row;align-items:center;}
  .metric{font-size:14px;padding:10px;}
  .commentsContent{padding:12px;}
}
</style>
</head>
<body>
<main class="app">

<!-- LOGIN -->
<section id="authPanel" class="panel centered">
  <h2>Bienvenido</h2>
  <p class="small">Inicia sesi√≥n o crea una cuenta. Usuario demo: <strong>demo@demo.com / demo</strong></p>
  <form autocomplete="off" onsubmit="return false;">
    <div>
      <label>Email o usuario</label>
      <input id="email" type="text" placeholder="tucorreo@ejemplo.com" required />
    </div>
    <div>
      <label>Contrase√±a</label>
      <input id="password" type="password" placeholder="m√≠n. 4 caracteres" required />
    </div>
    <div class="row" style="width:100%;">
      <button type="button" id="loginBtn" style="flex:1">Iniciar sesi√≥n</button>
      <button type="button" id="createBtn" class="ghost" style="flex:1">Crear cuenta</button>
    </div>
  </form>
</section>

<!-- DASHBOARD -->
<section id="dashPanel" class="panel dashboard" style="display:none">
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:8px;">
      <div id="userDisplay" style="font-weight:800"></div>
      <button id="commentsBtn" class="ghost">üí¨ Comentarios</button>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="toggleCamBtn" class="ghost">üì∑ C√°mara</button>
      <button id="logoutBtn" class="ghost">Cerrar sesi√≥n</button>
    </div>
  </div>

  <div>
    <div class="metric"><h3>Horas entrenadas</h3><div class="value" id="hoursVal">0</div></div>
    <div class="metric"><h3>Velocidad de reacci√≥n</h3><div class="value" id="reactionVal">‚Äî ms</div></div>
    <div class="metric"><h3>Concentraci√≥n</h3><div class="value" id="focusVal">‚Äî %</div></div>
    <div class="metric"><h3>Precisi√≥n</h3><div class="value" id="precisionVal">‚Äî %</div></div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
      <div class="big-stat" style="flex:1;min-width:160px;"><div class="num" id="lastUpdate">‚Äî</div><div class="label">√öltima actualizaci√≥n</div></div>
      <div class="big-stat" style="flex:1;min-width:160px;"><div class="num" id="sessionsVal">0</div><div class="label">Sesiones totales</div></div>
      <div class="big-stat" style="flex:1;min-width:160px;"><div class="num" id="bestReaction">‚Äî</div><div class="label">Mejor reacci√≥n</div></div>
    </div>

    <p id="statusText" class="small" style="margin-top:10px;">Intentando activar la c√°mara...</p>

    <div class="cameraWrapper" style="margin-top:6px;">
      <video id="webcam" autoplay playsinline muted></video>

      <!-- Fallback file input (capture) para file:// en m√≥viles -->
      <input id="fileCam" type="file" accept="image/*,video/*" capture="environment">
      <button id="activateFallback">Activar c√°mara (fallback)</button>
    </div>

  </div>
</section>

<!-- Modal Comentarios -->
<div id="commentsModal" class="commentsModal" role="dialog" aria-modal="true">
  <div class="commentsContent panel">
    <h3>Comentarios</h3>
    <div id="commentsList" style="margin-bottom:12px;"></div>

    <input id="usernameInput" placeholder="Tu nombre p√∫blico" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-bottom:8px;" />
    <textarea id="commentInput" placeholder="Escribe tu comentario..." rows="3"></textarea>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button id="postCommentBtn" style="flex:1;">Publicar</button>
      <button id="closeComments" class="ghost" style="flex:1;">Cerrar</button>
    </div>
  </div>
</div>

<script>
/* ==================== Utilidades y estado ==================== */
const $ = s => document.querySelector(s);
const emailInput = $('#email'), passInput = $('#password');
const loginBtn = $('#loginBtn'), createBtn = $('#createBtn'), logoutBtn = $('#logoutBtn');
const authPanel = $('#authPanel'), dashPanel = $('#dashPanel');
const userDisplay = $('#userDisplay'), hoursVal = $('#hoursVal'), reactionVal = $('#reactionVal');
const focusVal = $('#focusVal'), precisionVal = $('#precisionVal'), lastUpdate = $('#lastUpdate');
const sessionsVal = $('#sessionsVal'), bestReaction = $('#bestReaction'), statusText = $('#statusText');
const webcamEl = $('#webcam'), toggleCamBtn = $('#toggleCamBtn');
const fileCam = $('#fileCam'), activateFallback = $('#activateFallback');

const commentsBtn = $('#commentsBtn');
const commentsModal = $('#commentsModal');
const closeComments = $('#closeComments');
const postCommentBtn = $('#postCommentBtn');
const commentsList = $('#commentsList');
const commentInput = $('#commentInput');
const usernameInput = $('#usernameInput');

function hashPass(p){ return btoa(unescape(encodeURIComponent(p))); }
function saveUsers(){ localStorage.setItem('users', JSON.stringify(users)); }
function loadUsers(){ try { return JSON.parse(localStorage.getItem('users')) || {}; } catch(e){ return {}; } }

let users = loadUsers();
let current = localStorage.getItem('currentUser') || null;

/* Usuario demo: */
if(!users['demo@demo.com']){
  users['demo@demo.com'] = { pass: hashPass('demo'), sessions:0, hours:0, bestReaction:null, reaction:300, focus:68, precision:80 };
  saveUsers();
}

let stat = { hours:0, reaction:300, focus:68, precision:80, sessions:0, bestReaction:null };

/* ==================== UI & auth ==================== */
function updateUI(){
  hoursVal.textContent = stat.hours.toFixed(1);
  reactionVal.textContent = Math.round(stat.reaction) + ' ms';
  focusVal.textContent = Math.round(stat.focus) + ' %';
  precisionVal.textContent = Math.round(stat.precision) + ' %';
  sessionsVal.textContent = stat.sessions;
  bestReaction.textContent = stat.bestReaction ? Math.round(stat.bestReaction) + ' ms' : '‚Äî';
  lastUpdate.textContent = new Date().toLocaleTimeString();
}

function showDashboardFor(email){
  current = email;
  localStorage.setItem('currentUser', email);
  let u = users[email];
  stat = { ...u };
  stat.sessions = (stat.sessions || 0) + 1;
  users[email].sessions = stat.sessions; saveUsers();
  userDisplay.textContent = (email === 'demo@demo.com') ? '*ADMIN*' : (email.split('@')[0]);
  authPanel.style.display = 'none';
  dashPanel.style.display = 'block';
  updateUI();
  // Start camera attempt on show
  tryStartCamera();
}

function logout(){
  if(current && users[current]){ users[current] = { ...stat }; saveUsers(); }
  localStorage.removeItem('currentUser');
  current = null;
  dashPanel.style.display = 'none';
  authPanel.style.display = 'flex';
  emailInput.value = ''; passInput.value = '';
}

/* Login / create */
loginBtn.addEventListener('click', ()=>{
  const e = emailInput.value.trim(), p = passInput.value.trim();
  if(!e || !p){ alert('Email y contrase√±a'); return; }
  if(!users[e]){ alert('Usuario no encontrado'); return; }
  if(users[e].pass !== hashPass(p)){ alert('Contrase√±a incorrecta'); return; }
  showDashboardFor(e);
});
createBtn.addEventListener('click', ()=>{
  const e = emailInput.value.trim(), p = passInput.value.trim();
  if(!e || !p){ alert('Email y contrase√±a'); return; }
  if(users[e]){ alert('Usuario ya existe'); return; }
  users[e] = { pass: hashPass(p), sessions:0, hours:0, bestReaction:null, reaction:300, focus:68, precision:80 };
  saveUsers();
  alert('Cuenta creada con √©xito. Ahora inicia sesi√≥n.');
});
logoutBtn.addEventListener('click', logout);

/* Auto-login if existe */
if(current && users[current]) showDashboardFor(current);

/* ==================== C√°mara con fallback para file:// ==================== */
let stream = null;
let cameraActive = false;

async function tryStartCamera(){
  statusText.textContent = 'Intentando activar la c√°mara...';
  // Si ya hay stream, nothing
  if(cameraActive) return;
  // Intentar getUserMedia (puede fallar en file://)
  if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      webcamEl.srcObject = stream;
      webcamEl.style.display = 'block';
      statusText.textContent = 'C√°mara activa ‚úî';
      cameraActive = true;
      activateFallback.style.display = 'none';
      fileCam.style.display = 'none';
      // actualiza m√©tricas simuladas con 'datos' de la c√°mara
      startSimulatedMetrics(true);
      return;
    } catch(err) {
      console.warn('getUserMedia fallo:', err);
      // caida al fallback
    }
  }
  // Fallback: no getUserMedia ‚Äî usamos file input capture
  statusText.textContent = 'C√°mara no disponible v√≠a getUserMedia en archivo local. Pulsa "Activar c√°mara (fallback)".';
  activateFallback.style.display = 'block';
  fileCam.style.display = 'none';
  webcamEl.style.display = 'block'; // lo dejamos visible para mostrar la imagen/video seleccionado
  startSimulatedMetrics(false);
}

/* Botones para fallback y toggle */
activateFallback.addEventListener('click', ()=> {
  // Los navegadores requieren gesto del usuario para abrir input file
  fileCam.click();
});

toggleCamBtn.addEventListener('click', async ()=>{
  // Si c√°mara activa, apagar. Si no, intentar arrancar.
  if(cameraActive){
    shutdownCamera();
    statusText.textContent = 'C√°mara detenida.';
  } else {
    tryStartCamera();
    // Si getUserMedia no funciona, user tendr√° que pulsar fallback
  }
});

fileCam.addEventListener('change', (ev)=>{
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  // Si es video, asignamos al video element
  if(file.type.startsWith('video/')){
    webcamEl.srcObject = null;
    webcamEl.src = url;
    webcamEl.play().catch(()=>{ /* ignore */ });
    statusText.textContent = 'C√°mara (fallback) activa ‚Äî video cargado';
    cameraActive = true;
    activateFallback.style.display = 'none';
  } else if(file.type.startsWith('image/')){
    // Imagen: la mostramos en el video usando un canvas temporal si queremos; aqu√≠ cargamos en video via img->canvas->blob
    const img = new Image();
    img.onload = () => {
      const c = document.createElement('canvas');
      c.width = img.naturalWidth; c.height = img.naturalHeight;
      const ctx = c.getContext('2d'); ctx.drawImage(img,0,0);
      c.toBlob(blob=>{
        const blobUrl = URL.createObjectURL(blob);
        webcamEl.srcObject = null;
        webcamEl.src = blobUrl;
        webcamEl.play().catch(()=>{ /* ignore */ });
      }, 'image/jpeg');
      statusText.textContent = 'C√°mara (fallback) activa ‚Äî foto cargada';
      cameraActive = true;
      activateFallback.style.display = 'none';
    };
    img.src = url;
  } else {
    statusText.textContent = 'Archivo no soportado';
  }
});

/* Apagar c√°mara */
function shutdownCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }
  webcamEl.pause();
  webcamEl.srcObject = null;
  webcamEl.src = '';
  cameraActive = false;
  tryStartCamera(); // deja en estado listo para fallback
}

/* ==================== M√©tricas (simuladas, pero sensibles a si hay video) ==================== */
let metricsInterval = null;
function startSimulatedMetrics(hasRealCamera){
  if(metricsInterval) clearInterval(metricsInterval);
  metricsInterval = setInterval(()=>{
    // Si hay c√°mara real, variaciones m√°s "vivas"
    if(cameraActive && hasRealCamera){
      stat.reaction = Math.max(90, 150 + (Math.random()*140 - 40)); // mejor cuando real
      stat.focus = Math.min(99, 60 + Math.random()*40);
      stat.precision = Math.min(99, 70 + Math.random()*30);
    } else {
      // fallback / sin c√°mara: sigue simulando pero menos variaci√≥n
      stat.reaction = 200 + Math.random()*120;
      stat.focus = 45 + Math.random()*40;
      stat.precision = 60 + Math.random()*25;
    }
    stat.hours += 0.01;
    stat.bestReaction = stat.bestReaction ? Math.min(stat.bestReaction, stat.reaction) : stat.reaction;
    updateUI();
  }, 1800);
}

/* ==================== Comentarios ==================== */
let comments = JSON.parse(localStorage.getItem('comments') || '[]');
function saveComments(){ localStorage.setItem('comments', JSON.stringify(comments)); }

function getDisplayName(userName, email){
  if(email === 'demo@demo.com') return '*ADMIN*';
  return userName || 'Anon';
}

function renderComments(){
  commentsList.innerHTML = '';
  comments.forEach((c, i)=>{
    const div = document.createElement('div');
    div.className = 'comment';
    const when = new Date(c.date).toLocaleString();
    let repliesHtml = '';
    if(c.replies && c.replies.length){
      repliesHtml = c.replies.map(r=>`<div class="reply"><strong>${getDisplayName(r.username,r.user)}</strong>: ${escapeHtml(r.text)}</div>`).join('');
    }
    const canReply = !!current; // cualquiera logueado puede responder
    div.innerHTML = `<strong>${escapeHtml(getDisplayName(c.username, c.user))}</strong> <em style="color:#666;font-size:12px;">${when}</em>
      <p>${escapeHtml(c.text)}</p>
      ${repliesHtml}
      ${(canReply)?`<div style="margin-top:6px;"><button data-i="${i}" class="replyBtn" style="font-size:13px;padding:6px;border-radius:8px;border:0;background:#e2e8f0;">Responder</button></div>`:''}`;
    commentsList.appendChild(div);
  });
  // attach reply handlers
  document.querySelectorAll('.replyBtn').forEach(btn=>{
    btn.onclick = ()=>{
      const idx = parseInt(btn.dataset.i,10);
      const replyText = prompt('Escribe tu respuesta:');
      if(replyText){
        comments[idx].replies = comments[idx].replies || [];
        comments[idx].replies.push({ user: current, username: (current === 'demo@demo.com') ? '*ADMIN*' : '', text: replyText });
        saveComments(); renderComments();
      }
    };
  });
}

/* Modal comentarios */
commentsBtn.onclick = ()=>{
  commentsModal.style.display = 'flex';
  // Si admin, ocultar input username
  if(current === 'demo@demo.com'){
    usernameInput.style.display = 'none';
  } else {
    usernameInput.style.display = 'block';
    const prev = comments.find(c => c.user === current)?.username || '';
    usernameInput.value = prev;
  }
  renderComments();
};
closeComments.onclick = ()=>{ commentsModal.style.display='none'; commentInput.value=''; }

/* Publicar comentario */
postCommentBtn.onclick = ()=>{
  const text = commentInput.value.trim();
  if(!text){ alert('Escribe algo'); return; }
  const uname = (current === 'demo@demo.com') ? '*ADMIN*' : (usernameInput.value.trim() || 'Anon');
  comments.push({ user: current, username: uname, text: text, date: Date.now(), replies: [] });
  saveComments();
  commentInput.value = '';
  renderComments();
};

/* ==================== Helpers ==================== */
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}

/* Keep saving user stats on unload */
window.addEventListener('beforeunload', ()=>{
  if(current && users[current]){
    users[current] = { ...stat, pass: users[current].pass }; // keep pass
    saveUsers();
  }
});

/* Start an automatic attempt on load (if already logged) */
window.addEventListener('load', ()=>{
  // una tentativa autom√°tica solo cuando el dashboard est√° visible
  if(current && users[current]) {
    // tryStartCamera() se llama en showDashboardFor
  }
});

// Intenta arrancar c√°mara al entrar al dashboard (si ya logueado)
</script>

</main>
</body>
</html>
